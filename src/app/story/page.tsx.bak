"use client";

import React, { useEffect, useState, useRef } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { motion } from 'framer-motion';
import DOMPurify from 'isomorphic-dompurify';
import { ArrowLeft } from 'lucide-react';

const calculateReadTime = (text: string) => {
  const wordsPerMinute = 130;
  const words = text.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} min`;
};

const cleanContent = (html: string) => {
  // Config DOMPurify to strip styles and classes for a clean reader view
  DOMPurify.addHook('afterSanitizeAttributes', function (node) {
    if ('removeAttribute' in node) {
      node.removeAttribute('style');
      node.removeAttribute('class');
      node.removeAttribute('width');
      node.removeAttribute('height');

      // Center images
      if (node.tagName === 'IMG') {
        node.classList.add('mx-auto', 'w-full', 'h-auto', 'rounded-2xl', 'my-8');
      }
      
      // Ensure figcaptions looked styled
      if (node.tagName === 'FIGCAPTION') {
        node.classList.add('text-center', 'text-sm', 'opacity-60', 'mt-2', 'italic');
      }
    }
  });

  return DOMPurify.sanitize(html, {
    USE_PROFILES: { html: true },
    FORBID_TAGS: ['style', 'script', 'input', 'form', 'button'],
    FORBID_ATTR: ['style', 'class', 'width', 'height']
  });
};

export default function StoryPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  const storyUrl = searchParams.get('url');
  const title = searchParams.get('title');
  const source = searchParams.get('source');
  const date = searchParams.get('date');
  const initialImageUrl = searchParams.get('imageUrl');

  const [fullContent, setFullContent] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [fetchError, setFetchError] = useState(false);

  useEffect(() => {
    if (storyUrl) {
      setIsLoading(true);
      fetch(`/api/read-mode?url=${encodeURIComponent(storyUrl)}&t=${Date.now()}`)
        .then(res => res.json())
        .then(data => {
            if (data.success && data.article?.content) {
                setFullContent(data.article.content);
            } else {
                setFetchError(true);
            }
        })
        .catch((err) => {
            console.error(err);
            setFetchError(true);
        })
        .finally(() => setIsLoading(false));
    }
  }, [storyUrl]);

  const readTime = fullContent ? calculateReadTime(fullContent) : (searchParams.get('readTime') || '5 min');

  return (
    <div className="fixed inset-0 bg-juice-green flex flex-col z-[100] overflow-hidden">
        {/* Card Container mimicking the modal but full screenish */}
         <motion.div 
            initial={{ y: "100%" }}
            animate={{ y: 0 }}
            exit={{ y: "100%" }}
            transition={{ type: "spring", damping: 25, stiffness: 200 }}
            className="flex-1 mt-0 md:mt-6 mx-0 md:mx-6 mb-0 md:mb-6 bg-juice-cream rounded-none md:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative"
          >
             {/* Header */}
             <div className="flex items-center justify-between p-4 md:p-6 border-b border-juice-green/10 bg-juice-cream/90 backdrop-blur-md sticky top-0 z-20">
                <div className="flex items-center gap-4">
                    <button 
                        onClick={() => router.back()}
                        className="flex items-center gap-2 px-3 py-2 -ml-2 rounded-full hover:bg-juice-green/5 text-juice-green transition-all group"
                    >
                        <ArrowLeft className="w-5 h-5 group-hover:-translate-x-1 transition-transform" />
                        <span className="font-bold text-xs uppercase tracking-widest">Go Back</span>
                    </button>
                    <div className="h-4 w-px bg-juice-green/10" />
                    <span className="font-mono text-[10px] md:text-xs font-bold uppercase tracking-widest text-juice-green/60 pt-0.5">
                        {source || 'Source'}
                    </span>
                    {isLoading && (
                        <span className="hidden md:flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-juice-orange animate-pulse">
                            <span className="w-1.5 h-1.5 bg-juice-orange rounded-full"></span>
                            Fetching Story...
                        </span>
                    )}
                </div>

                <a 
                    href={storyUrl || '#'}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-4 py-2 rounded-full border border-juice-green/20 text-[10px] font-bold uppercase tracking-widest text-juice-green hover:bg-juice-green hover:text-juice-cream transition-colors"
                >
                    Visit Original
                </a>
             </div>

             {/* Content Scroll Area */}
             <div className="flex-1 overflow-y-auto p-6 md:p-12 lg:p-20 scroll-smooth">
                 <div className="max-w-3xl mx-auto pb-20">
                    {/* Article Title Header */}
                    <header className="mb-10 text-center">
                        <h1 className="font-serif text-3xl md:text-5xl lg:text-6xl font-bold text-juice-green mb-6 leading-tight">
                            {title || 'Loading...'}
                        </h1>
                        <div className="flex items-center justify-center gap-3 text-juice-green/50 font-mono text-[10px] uppercase tracking-widest">
                             <span>{date}</span>
                             <span>â€¢</span>
                             <span>{readTime}</span>
                        </div>
                    </header>

                    {/* Image */}
                    {initialImageUrl && (
                        <div className="mb-10 rounded-2xl overflow-hidden shadow-lg aspect-video bg-juice-green/5">
                            <img src={initialImageUrl} alt="" className="w-full h-full object-cover" />
                        </div>
                    )}

                    {/* Error State */}
                    {fetchError && !isLoading && !fullContent && (
                        <div className="p-6 bg-red-50 border border-red-100 rounded-2xl text-center mb-8">
                             <p className="text-red-800 font-medium mb-2">Could not load the full article.</p>
                             <a href={storyUrl || '#'} target="_blank" className="text-xs font-bold uppercase tracking-widest text-red-600 underline">Read on {source}</a>
                        </div>
                    )}

                    {/* Body */}
                    <article className="prose prose-lg md:prose-xl prose-stone mx-auto 
                        prose-headings:font-serif prose-headings:font-bold prose-headings:text-juice-green 
                        prose-p:text-juice-green/90 prose-p:leading-relaxed prose-p:mb-6
                        prose-a:text-juice-orange prose-a:no-underline hover:prose-a:underline
                        prose-li:text-juice-green prose-strong:text-juice-green
                        prose-img:mx-auto prose-img:block prose-img:rounded-2xl prose-img:shadow-sm">
                        {fullContent ? (
                            <div dangerouslySetInnerHTML={{ __html: cleanContent(fullContent) }} />
                        ) : (
                           isLoading && (
                               <div className="space-y-4 opacity-50 animate-pulse">
                                   <div className="h-4 bg-gray-200 rounded w-full"></div>
                                   <div className="h-4 bg-gray-200 rounded w-5/6"></div>
                                   <div className="h-4 bg-gray-200 rounded w-4/6"></div>
                               </div>
                           )
                        )}
                    </article>
                 </div>
             </div>
          </motion.div>
    </div>
  );
}
